

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/image/headpic.jfif">
  <link rel="icon" type="image/png" href="/image/headpic.jfif">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="PokeStar">
  <meta name="keywords" content="">
  <title>FasterRCNN_ResNet101-从代码角度解析 - PokeStar&#39;s Blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"blog.pokestar.wang","root":"/","version":"1.8.7","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"iBJ8IeKzxC1t8gL78pOhBgve-9Nh9j0Va","app_key":"ikqlgnddeJu2RBBeFTSuRAyx","server_url":"https://ibj8iekz.lc-cn-e1-shared.com"}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.3.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>PokeStar的个人小站</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/image/bg/North-America-Nebula-Deepscape_Liron-Gertsman.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="FasterRCNN_ResNet101-从代码角度解析">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-09-24 16:03" pubdate>
        2021年9月24日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      5.4k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      85
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">FasterRCNN_ResNet101-从代码角度解析</h1>
            
            <div class="markdown-body">
              <h1 id="fasterrcnn_resnet101-从代码角度理解"><a class="markdownIt-Anchor" href="#fasterrcnn_resnet101-从代码角度理解"></a> FasterRCNN_ResNet101 从代码角度理解</h1>
<p>看完论文之后，想代码角度从头好好捋一遍以ResNet为Backbone的FasterRCNN的过程。使用的代码为<a target="_blank" rel="noopener" href="https://github.com/ruotianluo/pytorch-faster-rcnn">pytorch-faster-rcnn</a>，基于此版本阅读源码进行理解，首先基于demo理解网络前向传播的过程，以此来理解整个网络结构，以下是个人整理的网络结构图。由于博文结合代码，<strong>会略去函数中不相关的部分代码</strong>，完整代码参见上述代码仓库。</p>
<p><img src="https://gitee.com/pokestar/image-bed/raw/master/img/202109242134299.jpg" srcset="/img/loading.gif" alt="Faster RCNN 网络结构图" /></p>
<h2 id="代码入口"><a class="markdownIt-Anchor" href="#代码入口"></a> 代码入口</h2>
<p>首先看<code>demo.py</code>中的主函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># tools\demo.py</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    cfg.TEST.HAS_RPN = <span class="hljs-literal">True</span>  <span class="hljs-comment"># Use RPN for proposals</span><br>    args = parse_args()<br><br>    <span class="hljs-comment"># load network</span><br>    <span class="hljs-keyword">if</span> demonet == <span class="hljs-string">&#x27;vgg16&#x27;</span>:<br>        net = vgg16()<br>    <span class="hljs-keyword">elif</span> demonet == <span class="hljs-string">&#x27;res101&#x27;</span>:<br>      	<span class="hljs-comment">## 本文基于此配置  调用了resnetv1和network的init，初始化了很多参数</span><br>        net = resnetv1(num_layers=<span class="hljs-number">101</span>)  <span class="hljs-comment">#  lib/nets/resnet_v1.py</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> NotImplementedError<br>    <span class="hljs-comment">##  初始化了anchor scale radio等参数  调用_init_modules</span><br>    net.create_architecture(<span class="hljs-number">21</span>, tag=<span class="hljs-string">&#x27;default&#x27;</span>, anchor_scales=[<span class="hljs-number">8</span>, <span class="hljs-number">16</span>, <span class="hljs-number">32</span>])<br><br>    net.load_state_dict(<br>        torch.load(saved_model, map_location=<span class="hljs-keyword">lambda</span> storage, loc: storage))<br><br>    net.<span class="hljs-built_in">eval</span>()<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> torch.cuda.is_available():<br>        net._device = <span class="hljs-string">&#x27;cpu&#x27;</span><br>    net.to(net._device)<br>    <br>    print(<span class="hljs-string">&#x27;Loaded network &#123;:s&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(saved_model))<br><br>    im_names = [<br>        <span class="hljs-string">&#x27;000456.jpg&#x27;</span>, <span class="hljs-string">&#x27;000542.jpg&#x27;</span>, <span class="hljs-string">&#x27;001150.jpg&#x27;</span>, <span class="hljs-string">&#x27;001763.jpg&#x27;</span>, <span class="hljs-string">&#x27;004545.jpg&#x27;</span><br>    ]<br>    <span class="hljs-keyword">for</span> im_name <span class="hljs-keyword">in</span> im_names:<br>        print(<span class="hljs-string">&#x27;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~&#x27;</span>)<br>        print(<span class="hljs-string">&#x27;Demo for data/demo/&#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(im_name))<br>        <span class="hljs-comment"># 向网络模型中传入图片开始前向传播</span><br>        demo(net, im_name)<br><br>    plt.show()<br></code></pre></td></tr></table></figure>
<p>可以看到，网络的搭建主要是调用两个函数<code>net = resnetv1(num_layers=101)</code>和<code>net.create_architecture(21, tag='default', anchor_scales=[8, 16, 32])</code>，之后使用<code>net.load_state_dict(torch.load(saved_model, map_location=lambda storage, loc: storage))</code>传入已经训练好的参数，最后调用<code>demo(net, im_name)</code>来给网络传入图片开始前向传播。</p>
<p>查看两个网络搭建函数的具体实现，可以看到<code>resnetv1()</code>是一个继承了<code>Network类</code>的模型类，而查看具体的类结构可以看到，无论父类还是子类都只是初始化了网络的部分超参数。而<code>Network类</code>有一个<code>create_architecture()</code>方法可以初始化网络的一部分超参数以及调用自身的<code>_init_modules()</code>方法来初始化RPN层以及后续的分类层，之后再初始化权重。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># lib\nets\resnet_v1.py </span><br><span class="hljs-comment"># 具体函数实现已经省略</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">resnetv1</span>(<span class="hljs-params">Network</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, num_layers=<span class="hljs-number">50</span></span>):</span><br>        Network.__init__(self)<br>        self._feat_stride = [<br>            <span class="hljs-number">16</span>,<br>        ]<br>        self._feat_compress = [<br>            <span class="hljs-number">1.</span> / <span class="hljs-built_in">float</span>(self._feat_stride[<span class="hljs-number">0</span>]),<br>        ]<br>        self._num_layers = num_layers<br>        self._net_conv_channels = <span class="hljs-number">1024</span><br>        self._fc7_channels = <span class="hljs-number">2048</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_crop_pool_layer</span>(<span class="hljs-params">self, bottom, rois</span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_image_to_head</span>(<span class="hljs-params">self</span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_head_to_tail</span>(<span class="hljs-params">self, pool5</span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_init_head_tail</span>(<span class="hljs-params">self</span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">train</span>(<span class="hljs-params">self, mode=<span class="hljs-literal">True</span></span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load_pretrained_cnn</span>(<span class="hljs-params">self, state_dict</span>):</span><br><br><span class="hljs-comment"># lib\nets\network.py</span><br><span class="hljs-comment"># 许多暂时不需要的函数已经省略</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Network</span>(<span class="hljs-params">nn.Module</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span><br>        nn.Module.__init__(self)<br>        self._predictions = &#123;&#125;<br>        self._losses = &#123;&#125;<br>        self._anchor_targets = &#123;&#125;<br>        self._proposal_targets = &#123;&#125;<br>        self._layers = &#123;&#125;<br>        self._gt_image = <span class="hljs-literal">None</span><br>        self._act_summaries = &#123;&#125;<br>        self._score_summaries = &#123;&#125;<br>        self._event_summaries = &#123;&#125;<br>        self._image_gt_summaries = &#123;&#125;<br>        self._variables_to_fix = &#123;&#125;<br>        self._device = <span class="hljs-string">&#x27;cuda&#x27;</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_add_gt_image</span>(<span class="hljs-params">self</span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_add_gt_image_summary</span>(<span class="hljs-params">self</span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_add_act_summary</span>(<span class="hljs-params">self, key, tensor</span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_add_score_summary</span>(<span class="hljs-params">self, key, tensor</span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_add_train_summary</span>(<span class="hljs-params">self, key, var</span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_proposal_top_layer</span>(<span class="hljs-params">self, rpn_cls_prob, rpn_bbox_pred</span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_proposal_layer</span>(<span class="hljs-params">self, rpn_cls_prob, rpn_bbox_pred</span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_roi_pool_layer</span>(<span class="hljs-params">self, bottom, rois</span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_roi_align_layer</span>(<span class="hljs-params">self, bottom, rois</span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_anchor_target_layer</span>(<span class="hljs-params">self, rpn_cls_score</span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_proposal_target_layer</span>(<span class="hljs-params">self, rois, roi_scores</span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_anchor_component</span>(<span class="hljs-params">self, height, width</span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_smooth_l1_loss</span>(<span class="hljs-params">self, bbox_pred, bbox_targets, bbox_inside_weights, bbox_outside_weights, sigma=<span class="hljs-number">1.0</span>, dim=[<span class="hljs-number">1</span>]</span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_add_losses</span>(<span class="hljs-params">self, sigma_rpn=<span class="hljs-number">3.0</span></span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_region_proposal</span>(<span class="hljs-params">self, net_conv</span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_region_classification</span>(<span class="hljs-params">self, fc7</span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_image_to_head</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-keyword">raise</span> NotImplementedError<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_head_to_tail</span>(<span class="hljs-params">self, pool5</span>):</span><br>        <span class="hljs-keyword">raise</span> NotImplementedError<br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_architecture</span>(<span class="hljs-params">self, num_classes, tag=<span class="hljs-literal">None</span>, anchor_scales=(<span class="hljs-params"><span class="hljs-number">8</span>, <span class="hljs-number">16</span>, <span class="hljs-number">32</span></span>), anchor_ratios=(<span class="hljs-params"><span class="hljs-number">0.5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span></span>)</span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_init_modules</span>(<span class="hljs-params">self</span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_run_summary_op</span>(<span class="hljs-params">self, val=<span class="hljs-literal">False</span></span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_predict</span>(<span class="hljs-params">self</span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">forward</span>(<span class="hljs-params">self, image, im_info, gt_boxes=<span class="hljs-literal">None</span>, mode=<span class="hljs-string">&#x27;TRAIN&#x27;</span></span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">init_weights</span>(<span class="hljs-params">self</span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">extract_head</span>(<span class="hljs-params">self, image</span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_image</span>(<span class="hljs-params">self, image, im_info</span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">delete_intermediate_states</span>(<span class="hljs-params">self</span>):</span><br>      <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_summary</span>(<span class="hljs-params">self, blobs</span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">train_step</span>(<span class="hljs-params">self, blobs, train_op</span>):</span><br>      <br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">train_step_with_summary</span>(<span class="hljs-params">self, blobs, train_op</span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">train_step_no_return</span>(<span class="hljs-params">self, blobs, train_op</span>):</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">load_state_dict</span>(<span class="hljs-params">self, state_dict</span>):</span><br>            <br></code></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># lib\nets\network.py</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create_architecture</span>(<span class="hljs-params">self,</span></span><br><span class="hljs-function"><span class="hljs-params">                        num_classes,</span></span><br><span class="hljs-function"><span class="hljs-params">                        tag=<span class="hljs-literal">None</span>,</span></span><br><span class="hljs-function"><span class="hljs-params">                        anchor_scales=(<span class="hljs-params"><span class="hljs-number">8</span>, <span class="hljs-number">16</span>, <span class="hljs-number">32</span></span>),</span></span><br><span class="hljs-function"><span class="hljs-params">                        anchor_ratios=(<span class="hljs-params"><span class="hljs-number">0.5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span></span>)</span>):</span><br>    self._tag = tag<br><br>    self._num_classes = num_classes<br>    self._anchor_scales = anchor_scales<br>    self._num_scales = <span class="hljs-built_in">len</span>(anchor_scales)<br><br>    self._anchor_ratios = anchor_ratios<br>    self._num_ratios = <span class="hljs-built_in">len</span>(anchor_ratios)<br><br>    self._num_anchors = self._num_scales * self._num_ratios<br><br>    <span class="hljs-keyword">assert</span> tag != <span class="hljs-literal">None</span><br><br>    <span class="hljs-comment"># Initialize layers</span><br>    self._init_modules()<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_init_modules</span>(<span class="hljs-params">self</span>):</span><br>  	<span class="hljs-comment"># 定义Backbone</span><br>    self._init_head_tail()<br><br>    <span class="hljs-comment"># rpn</span><br>    self.rpn_net = nn.Conv2d(<br>        self._net_conv_channels, cfg.RPN_CHANNELS, [<span class="hljs-number">3</span>, <span class="hljs-number">3</span>], padding=<span class="hljs-number">1</span>)<br><br>    self.rpn_cls_score_net = nn.Conv2d(cfg.RPN_CHANNELS,<br>                                       self._num_anchors * <span class="hljs-number">2</span>, [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>])<br><br>    self.rpn_bbox_pred_net = nn.Conv2d(cfg.RPN_CHANNELS,<br>                                       self._num_anchors * <span class="hljs-number">4</span>, [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>])<br><br>    self.cls_score_net = nn.Linear(self._fc7_channels, self._num_classes)<br>    self.bbox_pred_net = nn.Linear(self._fc7_channels,<br>                                   self._num_classes * <span class="hljs-number">4</span>)<br><br>    self.init_weights()<br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">init_weights</span>(<span class="hljs-params">self</span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">normal_init</span>(<span class="hljs-params">m, mean, stddev, truncated=<span class="hljs-literal">False</span></span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">  weight initalizer: truncated normal and random normal.</span><br><span class="hljs-string">  &quot;&quot;&quot;</span><br>        <span class="hljs-comment"># x is a parameter</span><br>        <span class="hljs-keyword">if</span> truncated:<br>            m.weight.data.normal_().fmod_(<span class="hljs-number">2</span>).mul_(stddev).add_(<br>                mean)  <span class="hljs-comment"># not a perfect approximation</span><br>        <span class="hljs-keyword">else</span>:<br>            m.weight.data.normal_(mean, stddev)<br>        m.bias.data.zero_()<br><br>    normal_init(self.rpn_net, <span class="hljs-number">0</span>, <span class="hljs-number">0.01</span>, cfg.TRAIN.TRUNCATED)<br>    normal_init(self.rpn_cls_score_net, <span class="hljs-number">0</span>, <span class="hljs-number">0.01</span>, cfg.TRAIN.TRUNCATED)<br>    normal_init(self.rpn_bbox_pred_net, <span class="hljs-number">0</span>, <span class="hljs-number">0.01</span>, cfg.TRAIN.TRUNCATED)<br>    normal_init(self.cls_score_net, <span class="hljs-number">0</span>, <span class="hljs-number">0.01</span>, cfg.TRAIN.TRUNCATED)<br>    normal_init(self.bbox_pred_net, <span class="hljs-number">0</span>, <span class="hljs-number">0.001</span>, cfg.TRAIN.TRUNCATED)<br></code></pre></td></tr></table></figure>
<p>结合之前给出的网络模型结构图，可以猜测<code>resnetv1()</code>是创建了一个网络类实例，而<code>create_architecture()</code>则定义了FasterRCNN网络的大部分具体结构。再调用<code>demo(net, im_name)</code>来给网络传入输入图片。下面我们先根据<code>create_architecture()</code>查看整个网络的大部分具体结构，再查看网络传输前向传播的流程。</p>
<h2 id="网络结构定义"><a class="markdownIt-Anchor" href="#网络结构定义"></a> 网络结构定义</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># lib\nets\resnet_v1.py </span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_init_head_tail</span>(<span class="hljs-params">self</span>):</span><br>    <span class="hljs-comment"># choose different blocks for different number of layers</span><br>    <span class="hljs-keyword">if</span> self._num_layers == <span class="hljs-number">50</span>:<br>        self.resnet = resnet50()<br><br>    <span class="hljs-keyword">elif</span> self._num_layers == <span class="hljs-number">101</span>:<br>        self.resnet = resnet101()<br><br>    <span class="hljs-keyword">elif</span> self._num_layers == <span class="hljs-number">152</span>:<br>        self.resnet = resnet152()<br><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-comment"># other numbers are not supported</span><br>        <span class="hljs-keyword">raise</span> NotImplementedError<br><br>    <span class="hljs-comment"># Fix blocks 固定部分层</span><br>    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> self.resnet.bn1.parameters():<br>        p.requires_grad = <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> self.resnet.conv1.parameters():<br>        p.requires_grad = <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">assert</span> (<span class="hljs-number">0</span> &lt;= cfg.RESNET.FIXED_BLOCKS &lt; <span class="hljs-number">4</span>)<br>    <span class="hljs-keyword">if</span> cfg.RESNET.FIXED_BLOCKS &gt;= <span class="hljs-number">3</span>:<br>        <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> self.resnet.layer3.parameters():<br>            p.requires_grad = <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">if</span> cfg.RESNET.FIXED_BLOCKS &gt;= <span class="hljs-number">2</span>:<br>        <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> self.resnet.layer2.parameters():<br>            p.requires_grad = <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">if</span> cfg.RESNET.FIXED_BLOCKS &gt;= <span class="hljs-number">1</span>:<br>        <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> self.resnet.layer1.parameters():<br>            p.requires_grad = <span class="hljs-literal">False</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_bn_fix</span>(<span class="hljs-params">m</span>):</span><br>        classname = m.__class__.__name__<br>        <span class="hljs-keyword">if</span> classname.find(<span class="hljs-string">&#x27;BatchNorm&#x27;</span>) != -<span class="hljs-number">1</span>:<br>            <span class="hljs-keyword">for</span> p <span class="hljs-keyword">in</span> m.parameters():<br>                p.requires_grad = <span class="hljs-literal">False</span><br><br>    self.resnet.apply(set_bn_fix)<br><br>    <span class="hljs-comment"># Build resnet.</span><br>    self._layers[<span class="hljs-string">&#x27;head&#x27;</span>] = nn.Sequential(<br>        self.resnet.conv1, self.resnet.bn1, self.resnet.relu,<br>        self.resnet.maxpool, self.resnet.layer1, self.resnet.layer2,<br>        self.resnet.layer3)<br><span class="hljs-comment"># lib\nets\network.py    </span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_init_modules</span>(<span class="hljs-params">self</span>):</span><br>  	<span class="hljs-comment"># 定义Backbone</span><br>    self._init_head_tail()<br><br>    <span class="hljs-comment"># rpn</span><br>    self.rpn_net = nn.Conv2d(self._net_conv_channels, cfg.RPN_CHANNELS, [<span class="hljs-number">3</span>, <span class="hljs-number">3</span>], padding=<span class="hljs-number">1</span>)<br><br>    self.rpn_cls_score_net = nn.Conv2d(cfg.RPN_CHANNELS, self._num_anchors * <span class="hljs-number">2</span>, [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>])<br><br>    self.rpn_bbox_pred_net = nn.Conv2d(cfg.RPN_CHANNELS, self._num_anchors * <span class="hljs-number">4</span>, [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>])<br><br>    <span class="hljs-comment"># classfication</span><br>    self.cls_score_net = nn.Linear(self._fc7_channels, self._num_classes)<br>    self.bbox_pred_net = nn.Linear(self._fc7_channels, self._num_classes * <span class="hljs-number">4</span>)<br></code></pre></td></tr></table></figure>
<p>以上代码定义了Faster RCNN网络大部分具体结构，我们可以把它整理简化一下，结合论文阅读的了解到的结构添加上还没实现的部分，更方便理解。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 定义Backbone </span><br>self.resnet = resnet101()<br>self._layers[<span class="hljs-string">&#x27;head&#x27;</span>] = nn.Sequential(<br>    self.resnet.conv1, self.resnet.bn1, self.resnet.relu,<br>    self.resnet.maxpool, self.resnet.layer1, self.resnet.layer2,<br>    self.resnet.layer3)<br><br><span class="hljs-comment">## <span class="hljs-doctag">TODO:</span> Anchors生成</span><br><br><span class="hljs-comment"># 定义rpn网络 </span><br>self.rpn_net = nn.Conv2d(self._net_conv_channels, cfg.RPN_CHANNELS, [<span class="hljs-number">3</span>, <span class="hljs-number">3</span>], padding=<span class="hljs-number">1</span>)<br><br><span class="hljs-comment"># RPN后的分类回归网络 生成ROIs</span><br>self.rpn_cls_score_net = nn.Conv2d(cfg.RPN_CHANNELS, self._num_anchors * <span class="hljs-number">2</span>, [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>])<br><br>self.rpn_bbox_pred_net = nn.Conv2d(cfg.RPN_CHANNELS, self._num_anchors * <span class="hljs-number">4</span>, [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>])<br><br><span class="hljs-comment">## <span class="hljs-doctag">TODO:</span> ROI pooling</span><br><br><span class="hljs-comment"># 最后的分类回归层</span><br>self.cls_score_net = nn.Linear(self._fc7_channels, self._num_classes)<br>self.bbox_pred_net = nn.Linear(self._fc7_channels, self._num_classes * <span class="hljs-number">4</span>)<br></code></pre></td></tr></table></figure>
<p>到这里，网络的结构定义已经相对明了了。下一步我们来了解前向传播的过程，先从之前找到的入口<code>demo(net, im_name)</code>开始。</p>
<h2 id="前向传播过程"><a class="markdownIt-Anchor" href="#前向传播过程"></a> 前向传播过程</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># tools\demo.py</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">demo</span>(<span class="hljs-params">net, image_name</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;Detect object classes in an image using pre-computed object proposals.&quot;&quot;&quot;</span><br><br>    <span class="hljs-comment"># Load the demo image</span><br>    im_file = os.path.join(cfg.DATA_DIR, <span class="hljs-string">&#x27;demo&#x27;</span>, image_name)<br>    im = cv2.imread(im_file)<br><br>    <span class="hljs-comment"># Detect all object classes and regress object bounds</span><br>    timer = Timer()<br>    timer.tic()<br>    <span class="hljs-comment">## 调用网络开始前向传播以及接收传回的结果</span><br>    scores, boxes = im_detect(net, im)<br>    timer.toc()<br>    print(<span class="hljs-string">&#x27;Detection took &#123;:.3f&#125;s for &#123;:d&#125; object proposals&#x27;</span>.<span class="hljs-built_in">format</span>(<br>        timer.total_time(), boxes.shape[<span class="hljs-number">0</span>]))<br><br>    <span class="hljs-comment"># Visualize detections for each class</span><br>    CONF_THRESH = <span class="hljs-number">0.8</span><br>    NMS_THRESH = <span class="hljs-number">0.3</span><br>    <span class="hljs-keyword">for</span> cls_ind, cls <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(CLASSES[<span class="hljs-number">1</span>:]):<br>        cls_ind += <span class="hljs-number">1</span>  <span class="hljs-comment"># because we skipped background</span><br>        cls_boxes = boxes[:, <span class="hljs-number">4</span> * cls_ind:<span class="hljs-number">4</span> * (cls_ind + <span class="hljs-number">1</span>)]<br>        cls_scores = scores[:, cls_ind]<br>        dets = np.hstack((cls_boxes,<br>                          cls_scores[:, np.newaxis])).astype(np.float32)<br>        keep = nms(<br>            torch.from_numpy(cls_boxes), torch.from_numpy(cls_scores),<br>            NMS_THRESH)<br>        dets = dets[keep.numpy(), :]<br>        vis_detections(im, cls, dets, thresh=CONF_THRESH)<br></code></pre></td></tr></table></figure>
<p>进一步查看后，发现在<code>demo()</code>方法中只有一条语句涉及网络调用<code>scores, boxes = im_detect(net, im)</code>。那么我们下一步就基于这个函数进行研究。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># lib\model\test.py</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">im_detect</span>(<span class="hljs-params">net, im</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;Convert an image and RoIs within that image into network inputs.&quot;&quot;&quot;</span><br>    blobs, im_scales = _get_blobs(im)<br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(im_scales) == <span class="hljs-number">1</span>, <span class="hljs-string">&quot;Only single-image batch implemented&quot;</span><br><br>    im_blob = blobs[<span class="hljs-string">&#x27;data&#x27;</span>]<br>    blobs[<span class="hljs-string">&#x27;im_info&#x27;</span>] = np.array(<br>        [im_blob.shape[<span class="hljs-number">1</span>], im_blob.shape[<span class="hljs-number">2</span>], im_scales[<span class="hljs-number">0</span>]], dtype=np.float32)<br><br>    <span class="hljs-comment"># 模型传入图片进行计算</span><br>    _, scores, bbox_pred, rois = net.test_image(blobs[<span class="hljs-string">&#x27;data&#x27;</span>],<br>                                                blobs[<span class="hljs-string">&#x27;im_info&#x27;</span>])<br><br>    <span class="hljs-comment"># 从ROI中提取bounding_box</span><br>    boxes = rois[:, <span class="hljs-number">1</span>:<span class="hljs-number">5</span>] / im_scales[<span class="hljs-number">0</span>]<br>    scores = np.reshape(scores, [scores.shape[<span class="hljs-number">0</span>], -<span class="hljs-number">1</span>])<br>    bbox_pred = np.reshape(bbox_pred, [bbox_pred.shape[<span class="hljs-number">0</span>], -<span class="hljs-number">1</span>])<br>    <span class="hljs-keyword">if</span> cfg.TEST.BBOX_REG:<br>        <span class="hljs-comment"># Apply bounding-box regression deltas 将预测的偏移应用到boundingbox上</span><br>        box_deltas = bbox_pred<br>        <span class="hljs-comment"># 传入预测框和偏移量</span><br>        pred_boxes = bbox_transform_inv(<br>            torch.from_numpy(boxes), torch.from_numpy(box_deltas)).numpy()<br>        pred_boxes = _clip_boxes(pred_boxes, im.shape) <span class="hljs-comment"># 防止anchor超出图片</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-comment"># Simply repeat the boxes, once for each class</span><br>        pred_boxes = np.tile(boxes, (<span class="hljs-number">1</span>, scores.shape[<span class="hljs-number">1</span>]))<br><br>    <span class="hljs-keyword">return</span> scores, pred_boxes<br></code></pre></td></tr></table></figure>
<p>这个函数的逻辑也比较清晰，首先对传入的图片进行一些处理，再将其送入<code>net.test_image()</code>函数中进行前向传播，得到分类分数scores，RPN预测的ROI框坐标rois以及相应预测的框偏移量bbox_pred，在使用<code>bbox_transform_inv()</code>函数转换成最终的预测边界框。关于<code>bbox_transform_inv()</code>这个函数，实现逻辑比较简单，就不贴源码了。它的主要作用是输入一组anchors（每个的形式为左上x，y，右下x，y）和一组deltas（anchors对应的偏移量，每个的形式为dx，dy，dw，dh），返回加上偏移量后的正确的预测边界框（每个的形式为左上x，y，右下x，y）。所以我们的下一步是去<code>net.test_image()</code>中寻找模型是如何进行前向传播的。</p>
<p><code>net.test_image()</code>之前在<code>Network()</code>类的结构中就看到过，我们来看看他的具体实现。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># lib\nets\network.py</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_image</span>(<span class="hljs-params">self, image, im_info</span>):</span><br>    self.<span class="hljs-built_in">eval</span>()<br>    <span class="hljs-keyword">with</span> torch.no_grad():<br>        self.forward(image, im_info, <span class="hljs-literal">None</span>, mode=<span class="hljs-string">&#x27;TEST&#x27;</span>)<br>    cls_score, cls_prob, bbox_pred, rois = self._predictions[<span class="hljs-string">&quot;cls_score&quot;</span>].data.cpu().numpy(), \<br>                                                     self._predictions[<span class="hljs-string">&#x27;cls_prob&#x27;</span>].data.cpu().numpy(), \<br>                                                     self._predictions[<span class="hljs-string">&#x27;bbox_pred&#x27;</span>].data.cpu().numpy(), \<br>                                                     self._predictions[<span class="hljs-string">&#x27;rois&#x27;</span>].data.cpu().numpy()<br>    <span class="hljs-keyword">return</span> cls_score, cls_prob, bbox_pred, rois<br></code></pre></td></tr></table></figure>
<p>可以看到，他的主要逻辑就是调用<code>self.forward(image, im_info, None, mode='TEST')</code>之后，读出经前向传播后储存在类中的预测返回值cls_score，cls_prob，bbox_pred，rois。那么我们继续往下看forward函数的实现。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># lib\nets\network.py</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">forward</span>(<span class="hljs-params">self, image, im_info, gt_boxes=<span class="hljs-literal">None</span>, mode=<span class="hljs-string">&#x27;TRAIN&#x27;</span></span>):</span><br>    self._image_gt_summaries[<span class="hljs-string">&#x27;image&#x27;</span>] = image<br>    self._image_gt_summaries[<span class="hljs-string">&#x27;gt_boxes&#x27;</span>] = gt_boxes<br>    self._image_gt_summaries[<span class="hljs-string">&#x27;im_info&#x27;</span>] = im_info<br>    <br>    <span class="hljs-comment"># RGB BGR 输入图像预处理</span><br>    self._image = torch.from_numpy(image.transpose([<span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>,<br>                                                    <span class="hljs-number">2</span>])).to(self._device)<br>    self._im_info = im_info  <span class="hljs-comment"># No need to change; actually it can be an list</span><br>    self._gt_boxes = torch.from_numpy(gt_boxes).to(<br>        self._device) <span class="hljs-keyword">if</span> gt_boxes <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span><br>    <br>    self._mode = mode<br>    <br>    <span class="hljs-comment"># 主要的前向传播过程</span><br>    rois, cls_prob, bbox_pred = self._predict()<br>    <br>    <span class="hljs-keyword">if</span> mode == <span class="hljs-string">&#x27;TEST&#x27;</span>:<br>        stds = bbox_pred.data.new(cfg.TRAIN.BBOX_NORMALIZE_STDS).repeat(<br>            self._num_classes).unsqueeze(<span class="hljs-number">0</span>).expand_as(bbox_pred)<br>        means = bbox_pred.data.new(cfg.TRAIN.BBOX_NORMALIZE_MEANS).repeat(<br>            self._num_classes).unsqueeze(<span class="hljs-number">0</span>).expand_as(bbox_pred)<br>        self._predictions[<span class="hljs-string">&quot;bbox_pred&quot;</span>] = bbox_pred.mul(stds).add(means)<br>    <span class="hljs-keyword">else</span>:<br>        self._add_losses()  <span class="hljs-comment"># compute losses</span><br></code></pre></td></tr></table></figure>
<p>可以看到主要的前向传播都在<code>self._predict()</code>中，下一步查看这个函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># lib\nets\network.py</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_predict</span>(<span class="hljs-params">self</span>):</span><br>    <span class="hljs-comment"># This is just _build_network in tf-faster-rcnn</span><br>    <span class="hljs-comment"># Faster RCNN rpn出rois roihead出cls和bbox</span><br>    torch.backends.cudnn.benchmark = <span class="hljs-literal">False</span><br>    net_conv = self._image_to_head() <span class="hljs-comment"># 得到特征图 通道数变为1024  H W缩小16倍</span><br><br>    <span class="hljs-comment"># build the anchors for the image</span><br>    self._anchor_component(net_conv.size(<span class="hljs-number">2</span>), net_conv.size(<span class="hljs-number">3</span>))  <span class="hljs-comment"># 传入特征图的HW</span><br><br>    rois = self._region_proposal(net_conv) <span class="hljs-comment"># H*W*A,5  预测的边界框 前缀1</span><br>    <span class="hljs-keyword">if</span> cfg.POOLING_MODE == <span class="hljs-string">&#x27;align&#x27;</span>:<br>        pool5 = self._roi_align_layer(net_conv, rois)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-comment"># Tensor[K, C, output_size[0], output_size[1]]: The pooled RoIs.</span><br>        pool5 = self._roi_pool_layer(net_conv, rois)<br><br>    <span class="hljs-keyword">if</span> self._mode == <span class="hljs-string">&#x27;TRAIN&#x27;</span>:<br>        torch.backends.cudnn.benchmark = <span class="hljs-literal">True</span>  <span class="hljs-comment"># benchmark because now the input size are fixed</span><br>    fc7 = self._head_to_tail(pool5)  <span class="hljs-comment"># resnetv1</span><br><br>    cls_prob, bbox_pred = self._region_classification(fc7)<br><br>    <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> self._predictions.keys():<br>        self._score_summaries[k] = self._predictions[k]<br><br>    <span class="hljs-keyword">return</span> rois, cls_prob, bbox_pred<br></code></pre></td></tr></table></figure>
<p>可以看到，这个函数中包括了大部分的Faster RCNN前向传播的过程，包括Backbone生成feature map，RPN网络，ROI pooling等，接下来我们深入分析这个函数，来理解前向传播的过程以及网络的整体结构。</p>
<p>分析<code>_predict(self)</code>之后，它的主要代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Backbone部分 得到feature_map</span><br>net_conv = self._image_to_head() <span class="hljs-comment"># 得到特征图 通道数变为1024  H W缩小16倍</span><br><br><span class="hljs-comment"># 生成anchors</span><br>self._anchor_component(net_conv.size(<span class="hljs-number">2</span>), net_conv.size(<span class="hljs-number">3</span>))  <span class="hljs-comment"># 传入特征图的HW</span><br><br><span class="hljs-comment"># RPN网络 根据feature_map生成ROIs</span><br>rois = self._region_proposal(net_conv) <span class="hljs-comment"># H*W*A,5  预测的边界框 前缀</span><br><br><span class="hljs-comment"># 选择使用ROI_Aligin或者ROI_pooling</span><br><span class="hljs-keyword">if</span> cfg.POOLING_MODE == <span class="hljs-string">&#x27;align&#x27;</span>:<br>    pool5 = self._roi_align_layer(net_conv, rois)<br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-comment"># Tensor[K, C, output_size[0], output_size[1]]: The pooled RoIs.</span><br>    pool5 = self._roi_pool_layer(net_conv, rois)<br><br><span class="hljs-comment"># fc layer 这里使用的是resnet的layer4</span><br>fc7 = self._head_to_tail(pool5)  <span class="hljs-comment"># resnetv1</span><br><br><span class="hljs-comment"># 最后的两个分类回归层</span><br>cls_prob, bbox_pred = self._region_classification(fc7)<br></code></pre></td></tr></table></figure>
<h3 id="backbone"><a class="markdownIt-Anchor" href="#backbone"></a> BackBone</h3>
<p><code>net_conv = self._image_to_head()</code>这句语句是调用模型的<code>_image_to_head()</code>函数来得到特征图，而这个函数在原始父类<code>Network()</code>中只是声明了并没有实现，具体实现在子类<code>resnetv1()</code>中，如下所示。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># lin\nets\resnetv1.py</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_image_to_head</span>(<span class="hljs-params">self</span>):</span><br>    net_conv = self._layers[<span class="hljs-string">&#x27;head&#x27;</span>](self._image)<br>    self._act_summaries[<span class="hljs-string">&#x27;conv&#x27;</span>] = net_conv<br><br>    <span class="hljs-keyword">return</span> net_conv<br></code></pre></td></tr></table></figure>
<p>这里传入的<code>self._image</code>已经在<code>forward()</code>函数中设定好，由函数内容可得具体Backbone网络为<code>self._layers['head']</code>，之前已经看到其定义如下，使用这种方式定义头部网络可以方便地更换Backbone。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># Build resnet.</span><br>self._layers[<span class="hljs-string">&#x27;head&#x27;</span>] = nn.Sequential(<br>    self.resnet.conv1, self.resnet.bn1, self.resnet.relu,<br>    self.resnet.maxpool, self.resnet.layer1, self.resnet.layer2,<br>    self.resnet.layer3)<br></code></pre></td></tr></table></figure>
<p>这里使用了ResNet的conv1层到layer3层的网络作为Backbone，其网络定义如下所示，最后得到的将是宽高缩小16倍，通道数增加到1024维的feature map。</p>
<p><img src="https://gitee.com/pokestar/image-bed/raw/master/img/202109261341543.png" srcset="/img/loading.gif" alt="" /></p>
<h3 id="生成anchor"><a class="markdownIt-Anchor" href="#生成anchor"></a> 生成Anchor</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 生成anchors</span><br>self._anchor_component(net_conv.size(<span class="hljs-number">2</span>), net_conv.size(<span class="hljs-number">3</span>))  <span class="hljs-comment"># 传入特征图的HW</span><br><br><span class="hljs-comment"># lib\nets\network.py</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_anchor_component</span>(<span class="hljs-params">self, height, width</span>):</span><br>    <span class="hljs-comment"># just to get the shape right</span><br>    <span class="hljs-comment">#height = int(math.ceil(self._im_info.data[0, 0] / self._feat_stride[0]))</span><br>    <span class="hljs-comment">#width = int(math.ceil(self._im_info.data[0, 1] / self._feat_stride[0]))</span><br>    anchors, anchor_length = generate_anchors_pre(height, width,<br>                                           self._feat_stride, self._anchor_scales, self._anchor_ratios)<br>    self._anchors = torch.from_numpy(anchors).to(self._device)  <span class="hljs-comment"># h*w*A,4</span><br>    self._anchor_length = anchor_length <span class="hljs-comment"># anchors的总个数# h*w*A</span><br><br><span class="hljs-comment"># lib\layer_utils\snippets.py</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">generate_anchors_pre</span>(<span class="hljs-params">height, width, feat_stride,</span></span><br><span class="hljs-function"><span class="hljs-params">                         anchor_scales=(<span class="hljs-params"><span class="hljs-number">8</span>, <span class="hljs-number">16</span>, <span class="hljs-number">32</span></span>),</span></span><br><span class="hljs-function"><span class="hljs-params">                         anchor_ratios=(<span class="hljs-params"><span class="hljs-number">0.5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span></span>)</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot; </span><br><span class="hljs-string">    A wrapper function to generate anchors given different scales</span><br><span class="hljs-string">    Also return the number of anchors in variable &#x27;length&#x27;</span><br><span class="hljs-string">  	&quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 生成默认的一组anchors</span><br>    anchors = generate_anchors(ratios=np.array(anchor_ratios), scales=np.array(anchor_scales)) <span class="hljs-comment"># 9，4</span><br>    A = anchors.shape[<span class="hljs-number">0</span>] <span class="hljs-comment"># 9</span><br>    shift_x = np.arange(<span class="hljs-number">0</span>, width) * feat_stride  <span class="hljs-comment"># 0-w，扩大16倍即恢复到原图大小</span><br>    shift_y = np.arange(<span class="hljs-number">0</span>, height) * feat_stride<br>    shift_x, shift_y = np.meshgrid(shift_x, shift_y)   <span class="hljs-comment"># h，w</span><br>    shifts = np.vstack((shift_x.ravel(), shift_y.ravel(), shift_x.ravel(),<br>                        shift_y.ravel())).transpose()  <span class="hljs-comment"># h*w,4 均为左上坐标点即[左上x,y，左上x,y]</span><br>    K = shifts.shape[<span class="hljs-number">0</span>]  <span class="hljs-comment"># h*w 个像素点 需要 anchor</span><br>    <span class="hljs-comment"># width changes faster, so here it is H, W, C</span><br>    <span class="hljs-comment"># 将每个[左上x,y，左上x,y]加上了以0，0为左上坐标的一组锚框，得到K，A，4的最终锚框。</span><br>    anchors = anchors.reshape((<span class="hljs-number">1</span>, A, <span class="hljs-number">4</span>)) + shifts.reshape((<span class="hljs-number">1</span>, K, <span class="hljs-number">4</span>)).transpose((<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>))  <span class="hljs-comment"># K,A,4</span><br>    anchors = anchors.reshape((K * A, <span class="hljs-number">4</span>)).astype(np.float32, copy=<span class="hljs-literal">False</span>)<br>    length = np.int32(anchors.shape[<span class="hljs-number">0</span>]) <span class="hljs-comment"># k*A h*w*A</span><br><br>    <span class="hljs-keyword">return</span> anchors, length<br><br><span class="hljs-comment"># lib\layer_utils\generate_anchors.py</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">generate_anchors</span>(<span class="hljs-params">base_size=<span class="hljs-number">16</span>,</span></span><br><span class="hljs-function"><span class="hljs-params">                     ratios=[<span class="hljs-number">0.5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>],</span></span><br><span class="hljs-function"><span class="hljs-params">                     scales=<span class="hljs-number">2</span>**np.arange(<span class="hljs-params"><span class="hljs-number">3</span>, <span class="hljs-number">6</span></span>)</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    以默认16的长宽生成一组anchors（对应一个像素点，默认生成9个）</span><br><span class="hljs-string">  	Generate anchor (reference) windows by enumerating aspect ratios X</span><br><span class="hljs-string">  	scales wrt a reference (0, 0, 15, 15) window.</span><br><span class="hljs-string">  	&quot;&quot;&quot;</span><br><br>    base_anchor = np.array([<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, base_size, base_size]) - <span class="hljs-number">1</span> <span class="hljs-comment"># 基础anchor框，宽高均为16</span><br>    ratio_anchors = _ratio_enum(base_anchor, ratios)   <span class="hljs-comment"># 3,4 </span><br>    anchors = np.vstack([<br>        _scale_enum(ratio_anchors[i, :], scales)<br>        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(ratio_anchors.shape[<span class="hljs-number">0</span>])<br>    ])  <span class="hljs-comment"># 遍历三个anchor，每一个anchor三个放缩</span><br>    <span class="hljs-keyword">return</span> anchors  <span class="hljs-comment"># 9，4</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_ratio_enum</span>(<span class="hljs-params">anchor, ratios</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">  	Enumerate a set of anchors for each aspect ratio wrt an anchor.</span><br><span class="hljs-string">  	为每个长宽比枚举一组锚点。</span><br><span class="hljs-string">  	&quot;&quot;&quot;</span><br>    <span class="hljs-comment"># (0, 0, 15, 15)</span><br>    w, h, x_ctr, y_ctr = _whctrs(anchor)  <span class="hljs-comment"># 16 16 7.5 7.5</span><br>    size = w * h<br>    size_ratios = size / ratios <span class="hljs-comment"># 3，</span><br>    ws = np.<span class="hljs-built_in">round</span>(np.sqrt(size_ratios))  <span class="hljs-comment"># round 四舍五入  3，</span><br>    hs = np.<span class="hljs-built_in">round</span>(ws * ratios)  <span class="hljs-comment">#  元素对元素 3，</span><br>    <span class="hljs-comment"># 以原来的中心为中心 生成比例不同的anchor</span><br>    anchors = _mkanchors(ws, hs, x_ctr, y_ctr)<br>    <span class="hljs-keyword">return</span> anchors<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_scale_enum</span>(<span class="hljs-params">anchor, scales</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">  	Enumerate a set of anchors for each scale wrt an anchor.</span><br><span class="hljs-string">  	为每个缩放比枚举一组锚点。</span><br><span class="hljs-string">  	&quot;&quot;&quot;</span><br><br>    w, h, x_ctr, y_ctr = _whctrs(anchor)<br>    ws = w * scales<br>    hs = h * scales<br>    anchors = _mkanchors(ws, hs, x_ctr, y_ctr)<br>    <span class="hljs-keyword">return</span> anchors<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_whctrs</span>(<span class="hljs-params">anchor</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">  	Return width, height, x center, and y center for an anchor (window).</span><br><span class="hljs-string">  	给定anchor(左上x，y  右下x，y)，返回宽高和中心坐标</span><br><span class="hljs-string">  	&quot;&quot;&quot;</span><br>    <span class="hljs-comment"># (0, 0, 15, 15)</span><br>    w = anchor[<span class="hljs-number">2</span>] - anchor[<span class="hljs-number">0</span>] + <span class="hljs-number">1</span><br>    h = anchor[<span class="hljs-number">3</span>] - anchor[<span class="hljs-number">1</span>] + <span class="hljs-number">1</span><br>    x_ctr = anchor[<span class="hljs-number">0</span>] + <span class="hljs-number">0.5</span> * (w - <span class="hljs-number">1</span>)<br>    y_ctr = anchor[<span class="hljs-number">1</span>] + <span class="hljs-number">0.5</span> * (h - <span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">return</span> w, h, x_ctr, y_ctr<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_mkanchors</span>(<span class="hljs-params">ws, hs, x_ctr, y_ctr</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    给定宽高和中心坐标，返回(左上x，y  右下x，y)</span><br><span class="hljs-string">  	Given a vector of widths (ws) and heights (hs) around a center</span><br><span class="hljs-string">  	(x_ctr, y_ctr), output a set of anchors (windows).</span><br><span class="hljs-string">  	&quot;&quot;&quot;</span><br><br>    ws = ws[:, np.newaxis] <span class="hljs-comment"># 增加1维 n，1</span><br>    hs = hs[:, np.newaxis]<br>    anchors = np.hstack((x_ctr - <span class="hljs-number">0.5</span> * (ws - <span class="hljs-number">1</span>), y_ctr - <span class="hljs-number">0.5</span> * (hs - <span class="hljs-number">1</span>),<br>                         x_ctr + <span class="hljs-number">0.5</span> * (ws - <span class="hljs-number">1</span>), y_ctr + <span class="hljs-number">0.5</span> * (hs - <span class="hljs-number">1</span>)))  <span class="hljs-comment"># 左上x，y  右下x，y</span><br>    <span class="hljs-keyword">return</span> anchors <span class="hljs-comment"># n个anchor坐标（n，4）</span><br></code></pre></td></tr></table></figure>
<p>以上是根据<code>self._anchor_component(net_conv.size(2), net_conv.size(3))</code>进行溯源得到的一些列anchor生成函数。</p>
<p>大部分的操作结合注释和代码应该比较好懂，比较困扰我的是这里的<code>generate_anchors_pre()</code>中的操作，这里我的理解是每一个图片经过backbone之后都缩小了16倍，所以feature map的每一个点都是对16*16区域的投射，也相当于把一小块16*16*3的区域映射为了一个1024维的向量（参考之前的resnet backbone，实际上还有一个维度转换的卷积层），然后对每一个点生成一组基础大小为16*16的锚框，所以要对得到的feature map的宽高乘以16，也就是<code>feat_stride</code>的值。这样也解释了之后可以直接对RPN后的feature map进行分类和回归，也就是可以直接对feature map上的一个点进行分类（是物体或背景）和回归（anchor的偏移值）。</p>
<h3 id="rpn网络"><a class="markdownIt-Anchor" href="#rpn网络"></a> RPN网络</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs python">rois = self._region_proposal(net_conv) <span class="hljs-comment"># H*W*A,5  预测的边界框 前缀1</span><br><br><span class="hljs-comment"># network.py</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_region_proposal</span>(<span class="hljs-params">self, net_conv</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    self.rpn_net = nn.Conv2d(self._net_conv_channels, cfg.RPN_CHANNELS, [3, 3], padding=1)</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    rpn = F.relu(self.rpn_net(net_conv)) <span class="hljs-comment"># 3*3卷积 大小不变 维度变换为cfg.RPN_CHANNELS,</span><br>    self._act_summaries[<span class="hljs-string">&#x27;rpn&#x27;</span>] = rpn<br><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    self._num_anchors 每一个像素点对应的anchors</span><br><span class="hljs-string">    self.rpn_cls_score_net = nn.Conv2d(cfg.RPN_CHANNELS, self._num_anchors * 2, [1, 1])</span><br><span class="hljs-string">    self.rpn_bbox_pred_net = nn.Conv2d(cfg.RPN_CHANNELS, self._num_anchors * 4, [1, 1])</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    rpn_cls_score = self.rpn_cls_score_net(rpn)  <span class="hljs-comment"># 是否为物体</span><br>    <span class="hljs-comment"># batch * (num_anchors * 2) * h * w  [batch,(num_anchors * 2),h,w]</span><br><br>    <span class="hljs-comment"># change it so that the score has 2 as its channel size</span><br>    rpn_cls_score_reshape = rpn_cls_score.view(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, -<span class="hljs-number">1</span>, rpn_cls_score.size()[-<span class="hljs-number">1</span>])  <br>    <span class="hljs-comment"># batch * 2 * (num_anchors*h) * w  [1,2, h*num_anchors*batch ,w]</span><br>    <span class="hljs-comment"># 这里应该是默认batch为1了</span><br>    rpn_cls_prob_reshape = F.softmax(rpn_cls_score_reshape, dim=<span class="hljs-number">1</span>) <span class="hljs-comment"># 物体类或背景类</span><br><br>    <span class="hljs-comment"># Move channel to the last dimenstion, to fit the input of python functions</span><br>    rpn_cls_prob = rpn_cls_prob_reshape.view_as(rpn_cls_score).permute(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>)  <br>    <span class="hljs-comment"># batch * h * w * (num_anchors * 2)</span><br>    rpn_cls_score = rpn_cls_score.permute(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>)  <br>    <span class="hljs-comment"># batch * h * w * (num_anchors * 2)</span><br>    rpn_cls_score_reshape = rpn_cls_score_reshape.permute(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>).contiguous()  <br>    <span class="hljs-comment"># batch * (num_anchors*h) * w * 2</span><br>    rpn_cls_pred = torch.<span class="hljs-built_in">max</span>(rpn_cls_score_reshape.view(-<span class="hljs-number">1</span>, <span class="hljs-number">2</span>), <span class="hljs-number">1</span>)[<span class="hljs-number">1</span>]<br>    <span class="hljs-comment"># 得到最大值的index 也就是当前像素点的当前anchor是物体还是背景</span><br><br>    rpn_bbox_pred = self.rpn_bbox_pred_net(rpn) <span class="hljs-comment"># 偏移量</span><br>    rpn_bbox_pred = rpn_bbox_pred.permute(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>).contiguous()  <br>    <span class="hljs-comment"># batch * h * w * (num_anchors*4)</span><br><br>    <span class="hljs-keyword">if</span> self._mode == <span class="hljs-string">&#x27;TRAIN&#x27;</span>:<br>        rois, roi_scores = self._proposal_layer(rpn_cls_prob, rpn_bbox_pred)  <br>        <span class="hljs-comment"># rois, roi_scores are varible</span><br>        rpn_labels = self._anchor_target_layer(rpn_cls_score)<br>        rois, _ = self._proposal_target_layer(rois, roi_scores)<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">if</span> cfg.TEST.MODE == <span class="hljs-string">&#x27;nms&#x27;</span>:<br>            rois, _ = self._proposal_layer(rpn_cls_prob, rpn_bbox_pred)  <span class="hljs-comment"># H*W*A,5  前缀0</span><br>        <span class="hljs-keyword">elif</span> cfg.TEST.MODE == <span class="hljs-string">&#x27;top&#x27;</span>:<br>            rois, _ = self._proposal_top_layer(rpn_cls_prob, rpn_bbox_pred)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">raise</span> NotImplementedError<br><br>    self._predictions[<span class="hljs-string">&quot;rpn_cls_score&quot;</span>] = rpn_cls_score<br>    self._predictions[<span class="hljs-string">&quot;rpn_cls_score_reshape&quot;</span>] = rpn_cls_score_reshape<br>    self._predictions[<span class="hljs-string">&quot;rpn_cls_prob&quot;</span>] = rpn_cls_prob<br>    self._predictions[<span class="hljs-string">&quot;rpn_cls_pred&quot;</span>] = rpn_cls_pred<br>    self._predictions[<span class="hljs-string">&quot;rpn_bbox_pred&quot;</span>] = rpn_bbox_pred<br>    self._predictions[<span class="hljs-string">&quot;rois&quot;</span>] = rois<br><br>    <span class="hljs-keyword">return</span> rois<br></code></pre></td></tr></table></figure>
<p>RPN网络中大多数的网络层结构已经在注释中给出，先经由一个3*3的卷积层改变其维度，不改变其大小，再是一个ReLU，接着就像上文说的，一个点对应一个区域进行分类和回归，之后根据分类和回归的结果经由<code>self._proposal_layer()</code>得到ROIs。我们这里暂时不考虑训练时的情况。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># network.py</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_proposal_layer</span>(<span class="hljs-params">self, rpn_cls_prob, rpn_bbox_pred</span>):</span><br>    rois, rpn_scores = proposal_layer(rpn_cls_prob, rpn_bbox_pred, self._im_info, self._mode,<br>                                     self._feat_stride, self._anchors, self._num_anchors)<br>    <span class="hljs-keyword">return</span> rois, rpn_scores<br><br><span class="hljs-comment"># lib\layer_utils\proposal_layer.py</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">proposal_layer</span>(<span class="hljs-params">rpn_cls_prob, rpn_bbox_pred, im_info, cfg_key, _feat_stride,</span></span><br><span class="hljs-function"><span class="hljs-params">                   anchors, num_anchors</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    A simplified version compared to fast/er RCNN</span><br><span class="hljs-string">    For details please see the technical report</span><br><span class="hljs-string">  	&quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(cfg_key) == <span class="hljs-built_in">bytes</span>:<br>        cfg_key = cfg_key.decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>    pre_nms_topN = cfg[cfg_key].RPN_PRE_NMS_TOP_N<br>    post_nms_topN = cfg[cfg_key].RPN_POST_NMS_TOP_N<br>    nms_thresh = cfg[cfg_key].RPN_NMS_THRESH<br><br>    <span class="hljs-comment"># Get the scores and bounding boxes</span><br>    scores = rpn_cls_prob[:, :, :, num_anchors:]  <span class="hljs-comment"># batch * h * w * (num_anchors)</span><br>    rpn_bbox_pred = rpn_bbox_pred.view((-<span class="hljs-number">1</span>, <span class="hljs-number">4</span>))  <span class="hljs-comment"># batch*h*w*num_anchors ,(4)</span><br>    scores = scores.contiguous().view(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>)  <span class="hljs-comment"># batch * h * w * (num_anchors), 1</span><br>    proposals = bbox_transform_inv(anchors, rpn_bbox_pred)   <span class="hljs-comment"># 预测的边界框</span><br>    proposals = clip_boxes(proposals, im_info[:<span class="hljs-number">2</span>])<br><br>    <span class="hljs-comment"># Pick the top region proposals</span><br>    scores, order = scores.view(-<span class="hljs-number">1</span>).sort(descending=<span class="hljs-literal">True</span>)<br>    <span class="hljs-keyword">if</span> pre_nms_topN &gt; <span class="hljs-number">0</span>:<br>        order = order[:pre_nms_topN]<br>        scores = scores[:pre_nms_topN].view(-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>)<br>    proposals = proposals[order.data, :]<br><br>    <span class="hljs-comment"># Non-maximal suppression</span><br>    keep = nms(proposals, scores.squeeze(<span class="hljs-number">1</span>), nms_thresh)<br><br>    <span class="hljs-comment"># Pick th top region proposals after NMS</span><br>    <span class="hljs-keyword">if</span> post_nms_topN &gt; <span class="hljs-number">0</span>:<br>        keep = keep[:post_nms_topN]<br>    proposals = proposals[keep, :]<br>    scores = scores[keep, ]<br><br>    <span class="hljs-comment"># Only support single image as input</span><br>    batch_inds = proposals.new_zeros(proposals.size(<span class="hljs-number">0</span>), <span class="hljs-number">1</span>)<br>    blob = torch.cat((batch_inds, proposals), <span class="hljs-number">1</span>)  <span class="hljs-comment"># H*W*A,5  前缀0，为了之后pooling方便</span><br><br>    <span class="hljs-keyword">return</span> blob, scores<br></code></pre></td></tr></table></figure>
<p>主要的操作还是对ROIs进行了一个NMS操作，选出得分最高的几个anchors作为proposal。</p>
<h3 id="roi_pooling"><a class="markdownIt-Anchor" href="#roi_pooling"></a> ROI_pooling</h3>
<p>这里可以选择使用ROI_Aligin或者ROI_pooling，这里是二者都是直接调用的pytorch中的函数，具体实现可以去参阅pytorch的文档。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 选择使用ROI_Aligin或者ROI_pooling</span><br><span class="hljs-keyword">if</span> cfg.POOLING_MODE == <span class="hljs-string">&#x27;align&#x27;</span>:<br>    pool5 = self._roi_align_layer(net_conv, rois)<br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-comment"># Tensor[K, C, output_size[0], output_size[1]]: The pooled RoIs.</span><br>    pool5 = self._roi_pool_layer(net_conv, rois)<br><br><span class="hljs-comment"># network.py</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_roi_pool_layer</span>(<span class="hljs-params">self, bottom, rois</span>):</span><br>    <span class="hljs-keyword">return</span> RoIPool((cfg.POOLING_SIZE, cfg.POOLING_SIZE), <span class="hljs-number">1.0</span> / <span class="hljs-number">16.0</span>)(bottom, rois)  <br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_roi_align_layer</span>(<span class="hljs-params">self, bottom, rois</span>):</span><br>    <span class="hljs-keyword">return</span> RoIAlign((cfg.POOLING_SIZE, cfg.POOLING_SIZE), <span class="hljs-number">1.0</span> / <span class="hljs-number">16.0</span>, <span class="hljs-number">0</span>)(bottom, rois)<br></code></pre></td></tr></table></figure>
<h3 id="fc-layer-resnetlayer4"><a class="markdownIt-Anchor" href="#fc-layer-resnetlayer4"></a> fc layer (resnet.layer4)</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># fc layer 这里使用的是resnet的layer4</span><br>fc7 = self._head_to_tail(pool5)  <span class="hljs-comment"># resnetv1</span><br><br><span class="hljs-comment"># resnet_v1.py</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_head_to_tail</span>(<span class="hljs-params">self, pool5</span>):</span><br>    fc7 = self.resnet.layer4(pool5).mean(<span class="hljs-number">3</span>).mean(<br>        <span class="hljs-number">2</span>)  <span class="hljs-comment"># average pooling after layer4</span><br>    <span class="hljs-keyword">return</span> fc7<br></code></pre></td></tr></table></figure>
<p>fc7层就是使用了之前没有用到的ResNet的layer4并做了平均汇聚操作。</p>
<h3 id="最后的分类以及回归层"><a class="markdownIt-Anchor" href="#最后的分类以及回归层"></a> 最后的分类以及回归层</h3>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># 最后的两个分类回归层</span><br>cls_prob, bbox_pred = self._region_classification(fc7)<br><br><span class="hljs-comment"># network.py</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_region_classification</span>(<span class="hljs-params">self, fc7</span>):</span><br>    cls_score = self.cls_score_net(fc7)<br>    cls_pred = torch.<span class="hljs-built_in">max</span>(cls_score, <span class="hljs-number">1</span>)[<span class="hljs-number">1</span>]<br>    cls_prob = F.softmax(cls_score, dim=<span class="hljs-number">1</span>)<br>    bbox_pred = self.bbox_pred_net(fc7)<br><br>    self._predictions[<span class="hljs-string">&quot;cls_score&quot;</span>] = cls_score<br>    self._predictions[<span class="hljs-string">&quot;cls_pred&quot;</span>] = cls_pred<br>    self._predictions[<span class="hljs-string">&quot;cls_prob&quot;</span>] = cls_prob<br>    self._predictions[<span class="hljs-string">&quot;bbox_pred&quot;</span>] = bbox_pred<br><br>    <span class="hljs-keyword">return</span> cls_prob, bbox_pred<br>  <br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">self.cls_score_net = nn.Linear(self._fc7_channels, self._num_classes)</span><br><span class="hljs-string">self.bbox_pred_net = nn.Linear(self._fc7_channels, self._num_classes * 4)</span><br><span class="hljs-string">&quot;&quot;&quot;</span>  <br></code></pre></td></tr></table></figure>
<p>最后的分类回归层做法类似于RPN中，只是使用了线性层而不是1*1卷积层，同样这里和之前都是回归预测四个偏移量。</p>
<h2 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h2>
<p>本篇博客从代码的角度结合一次正向传播的过程理解了以ResNet为Backbone的Faster RCNN的结构，理完正向传播过程之后结合文章一开始的结构图应该能有更深刻的了解，这次阅读代码之旅对我理解Faster RCNN的帮助很大，希望也能对你有帮助。</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB/">论文阅读</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/deeplearning/">deeplearning</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/09/28/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0-DETR/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">论文阅读笔记-DETR</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/09/22/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0-Bottom-up%20Attention%20for%20VQA/">
                        <span class="hidden-mobile">论文阅读笔记-Bottom-Up and Top-Down Attention for Image Captioning and Visual Question Answering</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
    <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a>
  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- LeanCloud 统计PV -->
        <span id="leancloud-site-pv-container" style="display: none">
            总访问量 
            <span id="leancloud-site-pv"></span>
             次
          </span>
      
      
        <!-- LeanCloud 统计UV -->
        <span id="leancloud-site-uv-container" style="display: none">
            总访客数 
            <span id="leancloud-site-uv"></span>
             人
          </span>
      

    
  </div>


  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>




  <script defer src="/js/leancloud.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>





  

  
    <!-- KaTeX -->
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" />
  








  

  

  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>



</body>
</html>
